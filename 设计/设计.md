# 设计

## 常见设计

### 任务系统怎么保证任务完成后发奖一定成功




### 设计一个限流系统怎么做? 令牌桶

#### 漏桶算法

把请求比作是水, 水来了都先放进桶里, 并以恒定速度出水(处理请求), 当水流量过大会导致桶溢出, 即拒绝服务. 请求的最大出力速度也就是水从漏桶流出的速度.

基于漏桶(桶+恒定处理速度), 可以起到对请求整流效果. 漏桶算法可基于线程池来实现, 线程池用固定容量的阻塞队列+固定个数的处理线程来实现: 最简单且最常见的漏桶实现就是基于 SynchronousQueue 的线程池, 其相当于一个空桶+固定处理线程.

注意:原生的漏桶算法以恒定速度出水(处理请求), 但是实际场景中请求的处理耗时可能不相等, 为了实现恒定速率, 一般都是限定同时处理请求的最大线程数.

#### 令牌桶算法

滑动时间窗口算法就是根据当前时间获取对应的时间窗口, 时间窗口保存有流量相关的统计值, 根据该统计值判断是否触发流控.

- 令牌桶算法原理是系统以恒定的速率产生令牌, 然后把令牌放到令牌桶中, 令牌桶有一个容量, 当令牌桶满了的时候, 再向其中放令牌,  那么多余的令牌会被丢弃. 当想要处理一个请求的时候,需要从令牌桶中取出一个令牌,如果此时令牌桶中没有令牌, 则拒绝该请求.

- 实现方案是: 起一个 Timer 线程以固定频率往桶中放令牌, 桶满时令牌溢出, 业务线程咋获取令牌时直接从桶中获取即可.


#### 滑动时间窗口算法 (rolling window)

在计数器的基础上细分更多格子, 比如说 1分钟拆分成10个格子, 随着时间的前进10格像窗口一样前行, 每格都有自己的计数器, 窗口总计数是当前时间的流量.

#### Redis 实现 (计数器)

Redis 实现限流可以使用 lua 脚本原子增加统计数据来实现, 设置过期时间1秒即1秒的限流.

### 现有一个随机数可以生产0到4的数, 现在要用这个生成器生成0到6的随机数, 要保证生成的概率均匀

- 如果是从大到小的生成器, 那么只需要在生成的数不在范围内时, 重新生成即可, 因为每个数生成的概率都是一致的.
- 从小到大的生成器, 

### (2) 设计秒杀系统, 考虑正确性, 以及服务器不挂机如何设计, 怎么解决大并发
### 如何设计服务端日志, 需要记录哪些字段?
### 以微博为例，有1个亿的用户，同时用户之间有关注和粉丝，用户的关注和取关操作比较频繁，如何设计架构和API接口
### 设计一个定时任务管理器（从我同事那打听到的，我只有上面一个算法题）
### 压力测试
### 一个只能负载1000qps 怎么让它达到 10000 qps
### 接口限流怎么做
### 短连接 (数据库 + 重定向)
### 设计一个死锁
### 几千万数据的表扩充新的字段如何处理?
### 几千万数据的表如何分页?
### 海量数据如何排序?
### 如果一个服务端要求只能用快排，但恶意用户就是输入快排最坏情况的数据让其排序，导致服务端负载过大，如何解决
### 如何实现15分钟内订单未付款则自动取消订单的功能？
### 数据库两张表, 求在其中一个表的数据
### 两个大文件, 求在其中一个文件的数据
### 微信朋友圈有什么可以改进的地方, 存在什么数据模型
### 前端发送请求没收到响应，怎么查？追问：没有日志呢？不是在开发环境下，不能打断点呢？
### 100个数字排序 (bitmap, 分成小文件, 分而治之)
### 百万人访问我的博客, 如何处理? 数据库如何储存这些数据?
### 百万人访问的数据读写, 如何统计访问人数
### 对称加密和非对称加密
### 一天爬一千万条文章，怎么做设计？怎么并行协调？100 台服务器怎么尽可能负载均衡？
### 设计一个抢红包系统，要注意哪些点
### 设计一个微博社交系统，怎么更高效，索引怎么设计、提高效率，查询扫描行数，缓存设计
### 使用 PHP 手动实现一个生产者, 消费者模型
### 设计一个视频上传的流程。表设计？文件上传服务器的原理？cdn？高qps怎么处理？上传和请求？缓存怎么加？
### 有什么分布式 id 生成方法？各自的优缺点是什么？
### 反羊毛怎么做？
### 设计一个简单的智能家具系统，比如说加湿器和温湿度传感器关联，怎么设计？考虑哪些点？
### 设计一个登陆过程。md5 的原理？可逆么？
### 12306网站设计架构
### 一个电商系统，有id，商品名称字段，问你架构怎么设计，会涉及到模糊查询商品。双写过程会有分布事务问题，如何解决。如果采用最终一致性的思想，那么并发请求来了好几个发现数据不一致怎么办？
### 对于一个抢红包的需求，要求每个用户每分钟最多不能超过5次，问你怎么解决这个问题？
### 订单号不能重复，你怎么设计生成订单号？
### 分布式锁如何设计？
### 网络io模型。（面试官又跟我说NIO什么写代码要回调函数，然后自己维护一个状态机，一下子给我问懵了，赶紧说这个NIO代码很少写，可别往下问状态机啥的了）
### 作为调用方和被调用放如何对避免服务雪崩？
### 设计一个登录态系统。如何保证密码加传输。如果你想服务器请求非对称加密的公钥时，请求被拦截篡改你怎么办？
### 微信抢红包架构设计
### 高并发时如何限流